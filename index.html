<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Management System</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --primary:#4361ee;--success:#22c55e;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;
      --dark:#2d3436;--light:#f5f7fa;--border:#e0e6ed
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
    .container{max-width:100%;background:var(--light);min-height:100vh}
    .header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
    .route-selection{padding:15px}
    .route-label{color:#6c757d;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
    .routes-container{display:flex;gap:10px;overflow-x:auto;padding-bottom:5px}
    .route-btn{flex:0 0 auto;padding:12px 24px;border:2px solid var(--border);background:#fff;border-radius:12px;font-size:14px;font-weight:600;color:#495057;cursor:pointer;transition:.3s;white-space:nowrap;outline:none}
    .route-btn:hover{background:#f8f9fa;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .route-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .date-header{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f8f9fa;border-top:1px solid var(--border)}
    .date-input{padding:8px 12px;border:2px solid var(--border);border-radius:8px;font-size:14px;font-weight:500}
    .current-route{background:#e3f2fd;color:#1976d2;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600}
    .action-buttons{display:flex;gap:10px;padding:15px;background:#fff;overflow-x:auto}
    .action-btn{display:flex;align-items:center;gap:8px;padding:10px 20px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:.3s;white-space:nowrap;outline:none}
    .action-btn.load{background:var(--warning);color:#fff}
    .action-btn.calculate{background:var(--primary);color:#fff}
    .action-btn.clear{background:var(--danger);color:#fff}
    .action-btn.sync{background:var(--info);color:#fff}
    .action-btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .action-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .main-content{padding:15px}

    .category-accordion{margin-bottom:15px;border-radius:15px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .category-header{display:flex;justify-content:space-between;align-items:center;padding:18px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;cursor:pointer;transition:.3s;user-select:none}
    .category-header:hover{opacity:.95}
    .category-title{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:600}
    .category-icon{font-size:20px}
    .category-arrow{font-size:20px;transition:transform .3s}
    .category-accordion.expanded .category-arrow{transform:rotate(90deg)}
    .category-content{max-height:0;overflow:hidden;transition:max-height .3s ease;background:#fff}
    .category-accordion.expanded .category-content{max-height:3000px}
    .items-container{padding:15px}

    .item-box{background:#f8f9fa;border:2px solid var(--border);border-radius:12px;padding:15px;margin-bottom:15px;cursor:pointer;transition:.3s;position:relative}
    .item-box.locked{border-color:var(--warning);background:#fef3c7}
    .lock-indicator{position:absolute;top:10px;right:10px;background:var(--warning);color:#fff;padding:4px 8px;border-radius:12px;font-size:11px;display:none}
    .item-box.locked .lock-indicator{display:block}
    .item-box:hover{border-color:var(--primary);box-shadow:0 4px 12px rgba(67,97,238,.15)}
    .item-box.expanded{background:#fff;border-color:var(--primary)}

    .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .item-info{display:flex;align-items:center;gap:10px}
    .item-code{background:var(--primary);color:#fff;padding:4px 10px;border-radius:6px;font-weight:600;font-size:14px}
    .item-name{font-size:15px;font-weight:600;color:var(--dark)}
    .item-price{background:#00b4d8;color:#fff;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:600}

    /* 5 summary columns now (added Add. Transfer) */
    .item-summary{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:10px 0;border-top:1px solid var(--border);margin-top:10px}
    .summary-item{text-align:center}
    .summary-label{font-size:11px;color:#6c757d;margin-bottom:2px}
    .summary-value{font-size:16px;font-weight:700;color:var(--dark)}
    .summary-value.negative{color:var(--danger)}
    .summary-value.positive{color:var(--success)}

    .item-details{display:none;margin-top:15px;padding-top:15px;border-top:2px solid var(--border)}
    .item-box.expanded .item-details{display:block;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

    .input-row{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:15px}
    .input-group{background:#f8f9fa;padding:12px;border-radius:10px;border:2px solid transparent;transition:.3s}
    .input-group:focus-within{background:#fff;border-color:var(--primary);box-shadow:0 0 0 4px rgba(67,97,238,.1)}
    .input-label{font-size:12px;color:#6c757d;font-weight:600;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
    .input-with-unit{display:flex;gap:8px;align-items:center}
    .input-field{flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:18px;font-weight:600;background:#fff;color:var(--dark);outline:none;appearance:none;-webkit-appearance:none;text-align:center}
    .input-field:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,.1);transform:scale(1.05)}
    .unit-select{padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff;color:var(--dark);cursor:pointer;outline:none;min-width:90px}

    .calc-row{display:grid;grid-template-columns:1fr;gap:15px;margin-top:15px;padding:15px;background:linear-gradient(135deg,#f0f4f8,#d9e2ec);border-radius:10px}
    .calc-item{text-align:center;padding:14px;background:#fff;border-radius:8px}
    .calc-label{font-size:11px;color:#6c757d;margin-bottom:5px;text-transform:uppercase;font-weight:600}
    .calc-value{font-size:28px;font-weight:800;color:var(--dark)}
    .calc-value.positive{color:var(--success)}
    .calc-value.negative{color:var(--danger)}

    .bottom-actions{position:sticky;bottom:0;background:#fff;padding:15px;box-shadow:0 -2px 10px rgba(0,0,0,.1);display:flex;gap:10px}
    .save-btn,.submit-btn{flex:1;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;outline:none}
    .save-btn{background:var(--success);color:#fff}.submit-btn{background:var(--primary);color:#fff}
    .save-btn:hover,.submit-btn:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .save-btn:disabled,.submit-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

    .sync-status{position:fixed;top:20px;right:20px;background:#fff;padding:10px 15px;border-radius:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;align-items:center;gap:8px;z-index:200}
    .sync-indicator{width:8px;height:8px;border-radius:50%;animation:pulse 2s infinite}
    .sync-indicator.connected{background:var(--success)}
    .sync-indicator.disconnected{background:var(--danger)}
    .sync-indicator.syncing{background:var(--warning);animation:spin 1s linear infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}@keyframes spin{100%{transform:rotate(360deg)}}
    .sync-text{font-size:12px;font-weight:600;color:#6c757d}
    .active-users-badge{background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:5px}

    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:12px 24px;background:var(--dark);color:#fff;border-radius:25px;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;animation:slideUp .3s;z-index:1000;font-size:14px;font-weight:500}
    .toast.show{display:block}.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.info{background:var(--info)}.toast.warning{background:var(--warning)}
    @keyframes slideUp{from{transform:translate(-50%,100px);opacity:0}to{transform:translate(-50%,0);opacity:1}}

    .loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000}
    .loading.show{display:block}
    .spinner{width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}

    @media(max-width:768px){
      .input-row{grid-template-columns:1fr}
      .item-summary{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="route-selection">
        <div class="route-label">SELECT SALES ROUTE</div>
        <div class="routes-container">
          <button class="route-btn" onclick="app.selectRoute('Al-Hasa 1',this)">Al-Hasa 1</button>
          <button class="route-btn" onclick="app.selectRoute('Al-Hasa 2',this)">Al-Hasa 2</button>
          <button class="route-btn" onclick="app.selectRoute('Al-Hasa 3',this)">Al-Hasa 3</button>
          <button class="route-btn" onclick="app.selectRoute('Al-Hasa 4',this)">Al-Hasa 4</button>
          <button class="route-btn" onclick="app.selectRoute('Al-Hasa Wholesale',this)">Al-Hasa Wholesale</button>
        </div>
      </div>
      <div class="date-header">
        <input type="date" class="date-input" id="inventoryDate" />
        <div class="current-route" id="currentRouteDisplay">Route: None</div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="action-btn load" onclick="app.loadPreviousEntry()">📋 Load Previous</button>
      <button class="action-btn calculate" onclick="app.autoCalculateAll()">⚡ Calculate All</button>
      <button class="action-btn sync" onclick="app.forceSync()">🔄 Sync Data</button>
      <button class="action-btn clear" onclick="app.clearAllData()">🗑️ Clear All</button>
    </div>

    <div class="main-content" id="mainContent"></div>

    <div class="bottom-actions">
      <button class="save-btn" id="saveBtn" onclick="app.saveData()">💾 Save to Sheets</button>
      <button class="submit-btn" id="submitBtn" onclick="app.submitData()">✅ Submit & Lock</button>
    </div>
  </div>

  <div class="sync-status">
    <div class="sync-indicator disconnected" id="syncIndicator"></div>
    <span class="sync-text" id="syncText">Connecting...</span>
    <span class="active-users-badge" id="activeUsers">0 users</span>
  </div>

  <div class="toast" id="toast"></div>
  <div class="loading" id="loading"><div class="spinner"></div></div>

  <script src="config.js"></script>
  <script>
    class InventoryApp{
      constructor(){
        this.currentRoute='';
        this.lockedItems=new Set();
        this.heartbeatTimer=null;
        this.pollingTimer=null;
        this.lastServerTimestamp=0;
        this.activeUsers=0;
        this.expandedCategories=new Set();
        this.expandedItems=new Set();

        this.productCatalog={
          'Sunflower Seeds':[
            {code:'4402',name:'200g',unit:'bag',price:58,bundle:5},
            {code:'4401',name:'100g',unit:'bag',price:34,bundle:5},
            {code:'1129',name:'25g',unit:'bag',price:16,bundle:6},
            {code:'1116',name:'800g',unit:'bag',price:17,carton:12},
            {code:'1145',name:'130g',unit:'box',price:54,carton:6},
            {code:'1126',name:'10KG',unit:'sack',price:160}
          ],
          'Pumpkin Seeds':[
            {code:'8001',name:'15g',unit:'box',price:16,carton:6},
            {code:'8002',name:'110g',unit:'box',price:54,carton:6},
            {code:'1142',name:'10KG',unit:'sack',price:230}
          ],
          'Melon Seeds':[
            {code:'9001',name:'15g',unit:'box',price:16,carton:6},
            {code:'9002',name:'110g',unit:'box',price:54,carton:6}
          ],
          'Popcorn':[
            {code:'1701',name:'Cheese',unit:'bag',price:5,carton:8},
            {code:'1702',name:'Butter',unit:'bag',price:5,carton:8},
            {code:'1703',name:'Lightly Salted',unit:'bag',price:5,carton:8}
          ]
        };
      }

      async init(){
        const today=new Date();
        document.getElementById('inventoryDate').value=today.toISOString().split('T')[0];

        this.renderCategories();
        this.loadFromLocalStorage();

        this.startHeartbeat();
        this.startPolling();
        await this.testConnection();
      }

      async testConnection(){
        try{
          const data=await callAppsScript('testConnection');
          if(data.status==='success'){
            this.updateSyncStatus('connected');
            this.showToast('Connected to server','success');
          }else{throw new Error('Connection failed')}
        }catch(e){
          this.updateSyncStatus('disconnected');
          this.showToast('Working offline - data will sync when connected','warning');
        }
      }

      startHeartbeat(){
        this.sendHeartbeat();
        this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),CONFIG.HEARTBEAT_INTERVAL);
      }
      async sendHeartbeat(){
        try{
          const data=await callAppsScript('heartbeat',{
            userId:CONFIG.USER_ID,
            route:this.currentRoute,
            module:'inventory',
            userName:'Inventory User'
          });
          if(data.status==='success'){
            this.activeUsers=data.data.activeUsers;
            document.getElementById('activeUsers').textContent=`${this.activeUsers} users`;
          }
        }catch(err){console.error('Heartbeat error:',err)}
      }

      startPolling(){this.pollingTimer=setInterval(()=>this.pollForUpdates(),CONFIG.POLLING_INTERVAL)}
      async pollForUpdates(){
        if(!this.currentRoute) return;
        try{
          const data=await callAppsScript('getRealTimeData',{
            route:this.currentRoute,
            timestamp:this.lastServerTimestamp,
            date:document.getElementById('inventoryDate').value
          });
          if(data.status==='success'){this.processUpdates(data.data)}
        }catch(err){console.error('Polling error:',err)}
      }
      processUpdates(data){
        if(data.lockedItems){
          this.lockedItems.clear();
          data.lockedItems.forEach(li=>{if(li.userId!==CONFIG.USER_ID)this.lockedItems.add(li.itemKey)});
          this.updateLockedItemsUI();
        }
        if(data.updates&&data.updates.length>0){
          data.updates.forEach(u=>{
            if(u.type==='route_update'&&u.route===this.currentRoute){
              this.showToast('Data updated by another user','info');
              this.lastServerTimestamp=u.timestamp;
            }
          });
        }
        if(data.serverTimestamp){this.lastServerTimestamp=data.serverTimestamp}
      }
      updateLockedItemsUI(){
        this.lockedItems.forEach(k=>{
          const [route,code]=k.split('_');
          if(route===this.currentRoute){
            const box=document.getElementById(`item-${code}`);
            if(box) box.classList.add('locked');
          }
        });
      }

      async lockItem(code){
        try{
          const data=await callAppsScript('lockItem',{route:this.currentRoute,itemCode:code,userId:CONFIG.USER_ID});
          if(data.status==='error'){this.showToast('Item is being edited by another user','warning');return false}
          return true;
        }catch(err){console.error('Lock error:',err);return true}
      }
      async unlockItem(code){
        try{await callAppsScript('unlockItem',{route:this.currentRoute,itemCode:code,userId:CONFIG.USER_ID})}
        catch(err){console.error('Unlock error:',err)}
      }

      selectRoute(route,btn){
        this.currentRoute=route;
        document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('currentRouteDisplay').textContent=`Route: ${route}`;
        this.showToast(`Selected: ${route}`,'info');
        this.saveToLocalStorage();
        this.sendHeartbeat();
      }

      renderCategories(){
        const container=document.getElementById('mainContent');
        container.innerHTML='';
        Object.entries(this.productCatalog).forEach(([category,items])=>{
          const div=this.createCategoryElement(category,items);
          container.appendChild(div);
        });
      }

      createCategoryElement(category,items){
        const div=document.createElement('div');
        div.className='category-accordion';
        if(this.expandedCategories.has(category)) div.classList.add('expanded');
        const icon=this.getCategoryIcon(category);
        div.innerHTML=`
          <div class="category-header" onclick="app.toggleCategory('${category}', this)">
            <div class="category-title">
              <span class="category-icon">${icon}</span>
              <span>${category.toUpperCase()}</span>
            </div>
            <span class="category-arrow">▶</span>
          </div>
          <div class="category-content">
            <div class="items-container">
              ${items.map(i=>this.createItemBox(category,i)).join('')}
            </div>
          </div>`;
        return div;
      }

      createItemBox(category,item){
        const itemId=`${category}-${item.code}`;
        const isExpanded=this.expandedItems.has(itemId);
        const isLocked=this.lockedItems.has(`${this.currentRoute}_${item.code}`);
        return `
          <div class="item-box ${isExpanded?'expanded':''} ${isLocked?'locked':''}" id="item-${item.code}">
            <div class="lock-indicator">Locked by another user</div>
            <div onclick="app.toggleItem('${category}','${item.code}')">
              <div class="item-header">
                <div class="item-info">
                  <span class="item-code">${item.code}</span>
                  <span class="item-name">${item.name}</span>
                </div>
                <span class="item-price">SAR ${item.price}</span>
              </div>
              <div class="item-summary">
                <div class="summary-item">
                  <div class="summary-label">Physical</div>
                  <div class="summary-value" id="summary-physical-${item.code}">0</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Transfer</div>
                  <div class="summary-value" id="summary-transfer-${item.code}">0</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Add Transfer</div>
                  <div class="summary-value" id="summary-addtransfer-${item.code}">0</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">System</div>
                  <div class="summary-value" id="summary-system-${item.code}">0</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Diff</div>
                  <div class="summary-value" id="summary-diff-${item.code}">0</div>
                </div>
              </div>
            </div>

            <div class="item-details">
              <div class="input-row">
                <div class="input-group">
                  <div class="input-label">Physical Stock</div>
                  <div class="input-with-unit">
                    <input type="number" class="input-field" id="physical-${item.code}" placeholder="0"
                      onfocus="app.onItemFocus('${item.code}')" onblur="app.onItemBlur('${item.code}')"
                      onchange="app.calculateItem('${item.code}')">
                    <select class="unit-select" id="physical-unit-${item.code}" onchange="app.calculateItem('${item.code}')">
                      ${this.getUnitOptions(item)}
                    </select>
                  </div>
                </div>

                <div class="input-group">
                  <div class="input-label">Stock Transfer</div>
                  <div class="input-with-unit">
                    <input type="number" class="input-field" id="transfer-${item.code}" placeholder="0"
                      onchange="app.calculateItem('${item.code}')">
                    <select class="unit-select" id="transfer-unit-${item.code}" onchange="app.calculateItem('${item.code}')">
                      ${this.getUnitOptions(item)}
                    </select>
                  </div>
                </div>
              </div>

              <div class="input-row">
                <div class="input-group">
                  <div class="input-label">Additional Transfer</div>
                  <div class="input-with-unit">
                    <input type="number" class="input-field" id="add-transfer-${item.code}" placeholder="0"
                      onchange="app.calculateItem('${item.code}')">
                    <select class="unit-select" id="add-transfer-unit-${item.code}" onchange="app.calculateItem('${item.code}')">
                      ${this.getUnitOptions(item)}
                    </select>
                  </div>
                </div>

                <div class="input-group">
                  <div class="input-label">System Stock</div>
                  <div class="input-with-unit">
                    <input type="number" class="input-field" id="system-${item.code}" placeholder="0"
                      onchange="app.calculateItem('${item.code}')">
                    <select class="unit-select" id="system-unit-${item.code}" onchange="app.calculateItem('${item.code}')">
                      ${this.getUnitOptions(item)}
                    </select>
                  </div>
                </div>
              </div>

              <div class="input-row">
                <div class="input-group">
                  <div class="input-label">Pieces Reimbursed</div>
                  <div class="input-with-unit">
                    <input type="number" class="input-field" id="reimburse-${item.code}" placeholder="0"
                      onchange="app.saveToLocalStorage()">
                    <span style="padding:12px;">pieces</span>
                  </div>
                </div>
              </div>

              <div class="calc-row">
                <div class="calc-item">
                  <div class="calc-label">Difference</div>
                  <div class="calc-value" id="diff-${item.code}">0</div>
                </div>
              </div>
            </div>
          </div>`;
      }

      getCategoryIcon(category){
        const icons={'Sunflower Seeds':'🌻','Pumpkin Seeds':'🎃','Melon Seeds':'🍉','Popcorn':'🍿'};
        return icons[category]||'📦';
      }
      getUnitOptions(item){
        let o=`<option value="${item.unit}">${item.unit}</option>`;
        if(item.bundle) o+=`<option value="bundle">bundle (${item.bundle})</option>`;
        if(item.carton) o+=`<option value="carton">carton (${item.carton})</option>`;
        return o;
      }

      toggleCategory(category,el){
        const acc=el.parentElement;
        acc.classList.toggle('expanded');
        if(this.expandedCategories.has(category)) this.expandedCategories.delete(category);
        else this.expandedCategories.add(category);
        this.saveToLocalStorage();
      }

      async toggleItem(category,code){
        const id=`${category}-${code}`;
        const box=document.getElementById(`item-${code}`);
        if(this.expandedItems.has(id)){
          this.expandedItems.delete(id);
          box.classList.remove('expanded');
          await this.unlockItem(code);
        }else{
          const ok=await this.lockItem(code);
          if(!ok) return;
          this.expandedItems.add(id);
          box.classList.add('expanded');
        }
        this.saveToLocalStorage();
      }
      async onItemFocus(code){await this.lockItem(code)}
      async onItemBlur(code){await this.unlockItem(code)}

      findItemByCode(code){
        for(const items of Object.values(this.productCatalog)){
          const f=items.find(i=>i.code===code);
          if(f) return f;
        }
        return null;
      }
      toBaseUnits(val,unit,item){
        if(!item) return val;
        if(unit==='bundle'&&item.bundle) return val*item.bundle;
        if(unit==='carton'&&item.carton) return val*item.carton;
        return val;
      }

      calculateItem(code){
        const item=this.findItemByCode(code);
        if(!item) return;

        const physical= parseFloat(document.getElementById(`physical-${code}`).value)||0;
        const physicalUnit=document.getElementById(`physical-unit-${code}`).value;

        const transfer= parseFloat(document.getElementById(`transfer-${code}`).value)||0;
        const transferUnit=document.getElementById(`transfer-unit-${code}`).value;

        const addTransfer= parseFloat(document.getElementById(`add-transfer-${code}`).value)||0;
        const addTransferUnit=document.getElementById(`add-transfer-unit-${code}`).value;

        const system= parseFloat(document.getElementById(`system-${code}`).value)||0;
        const systemUnit=document.getElementById(`system-unit-${code}`).value;

        const physicalBase=this.toBaseUnits(physical,physicalUnit,item);
        const transferBase=this.toBaseUnits(transfer,transferUnit,item);
        const addTransferBase=this.toBaseUnits(addTransfer,addTransferUnit,item);
        const systemBase=this.toBaseUnits(system,systemUnit,item);

        const diff=(physicalBase + transferBase + addTransferBase) - systemBase;

        // Write totals to UI
        const set=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=String(v)};
        set(`diff-${code}`,diff.toFixed(0));
        const dEl=document.getElementById(`diff-${code}`);
        dEl.className=`calc-value ${diff>0?'positive':diff<0?'negative':''}`;

        set(`summary-physical-${code}`,physicalBase.toFixed(0));
        set(`summary-transfer-${code}`,transferBase.toFixed(0));
        set(`summary-addtransfer-${code}`,addTransferBase.toFixed(0));
        set(`summary-system-${code}`,systemBase.toFixed(0));
        set(`summary-diff-${code}`,diff.toFixed(0));
        const sDiff=document.getElementById(`summary-diff-${code}`);
        sDiff.className=`summary-value ${diff>0?'positive':diff<0?'negative':''}`;

        this.saveToLocalStorage();
      }

      autoCalculateAll(){
        this.showToast('Calculating all items...','info');
        Object.values(this.productCatalog).forEach(items=>{
          items.forEach(item=>{
            if(document.getElementById(`physical-${item.code}`)) this.calculateItem(item.code);
          });
        });
        this.showToast('Calculations complete!','success');
      }

      loadPreviousEntry(){
        const saved=localStorage.getItem(`lastEntry_${this.currentRoute}`);
        if(saved){
          const data=JSON.parse(saved);
          this.populateForm(data);
          this.showToast('Previous entry loaded','success');
          setTimeout(()=>this.autoCalculateAll(),100);
        }else{this.showToast('No previous entry found','info')}
      }

      clearAllData(){
        if(!confirm('Clear all entered data?')) return;
        document.querySelectorAll('.input-field').forEach(i=>i.value='');
        document.querySelectorAll('.calc-value').forEach(el=>{el.textContent='0';el.className='calc-value'});
        document.querySelectorAll('.summary-value').forEach(el=>{el.textContent='0';el.className='summary-value'});
        this.showToast('All data cleared','info');
      }

      async saveData(){
        if(!this.currentRoute){this.showToast('Please select a route first','error');return}
        this.showLoading(true);
        const bundle=this.collectData();
        try{
          const res=await callAppsScript('saveInventoryData',{
            route:this.currentRoute,
            date:document.getElementById('inventoryDate').value,
            items:bundle.items
          });
          if(res.status==='success'){
            this.showToast('Data saved successfully!','success');
            localStorage.setItem(`lastEntry_${this.currentRoute}`,JSON.stringify(bundle));
          }else{throw new Error(res.data||'Save failed')}
        }catch(err){
          this.showToast('Error saving data: '+err.message,'error');
        }finally{this.showLoading(false)}
      }
      async submitData(){
        if(!confirm('Submit and lock this data? This action cannot be undone.')) return;
        await this.saveData();
      }
      async forceSync(){
        this.showLoading(true);this.updateSyncStatus('syncing');
        try{
          await this.pollForUpdates();await this.sendHeartbeat();
          this.updateSyncStatus('connected');this.showToast('Data synced successfully','success');
        }catch(err){
          this.updateSyncStatus('disconnected');this.showToast('Sync failed','error');
        }finally{this.showLoading(false)}
      }

      collectData(){
        const items=[];
        Object.entries(this.productCatalog).forEach(([category,products])=>{
          products.forEach(item=>{
            const physEl=document.getElementById(`physical-${item.code}`);
            if(!physEl) return;

            const physical=parseFloat(physEl.value)||0;
            const physUnit=document.getElementById(`physical-unit-${item.code}`).value;

            const transfer=parseFloat(document.getElementById(`transfer-${item.code}`).value)||0;
            const transUnit=document.getElementById(`transfer-unit-${item.code}`).value;

            const addTransfer=parseFloat(document.getElementById(`add-transfer-${item.code}`).value)||0;
            const addUnit=document.getElementById(`add-transfer-unit-${item.code}`).value;

            const system=parseFloat(document.getElementById(`system-${item.code}`).value)||0;
            const sysUnit=document.getElementById(`system-unit-${item.code}`).value;

            const reimburse=parseFloat(document.getElementById(`reimburse-${item.code}`).value)||0;

            if(physical||transfer||addTransfer||system||reimburse){
              const physicalBase=this.toBaseUnits(physical,physUnit,item);
              const transferBase=this.toBaseUnits(transfer,transUnit,item);
              const addTransferBase=this.toBaseUnits(addTransfer,addUnit,item);
              const systemBase=this.toBaseUnits(system,sysUnit,item);
              const difference=(physicalBase + transferBase + addTransferBase) - systemBase;

              items.push({
                category,
                code:item.code,
                name:item.name,
                physical:physicalBase,
                physUnit,
                transfer:transferBase,
                transUnit,
                addTransfer:addTransferBase,   // <-- NEW
                addUnit,                       // <-- NEW
                system:systemBase,
                sysUnit,
                difference,
                reimburse,
                reimbUnit:'pieces'
              });
            }
          });
        });
        return {items};
      }

      populateForm(data){
        if(!data.items) return;
        data.items.forEach(row=>{
          const set=(id,val)=>{const el=document.getElementById(id); if(el) el.value=val};
          set(`physical-${row.code}`,row.physical||'');
          set(`transfer-${row.code}`,row.transfer||'');
          set(`add-transfer-${row.code}`,row.addTransfer||'');
          set(`system-${row.code}`,row.system||'');
          set(`reimburse-${row.code}`,row.reimburse||'');
          const pu=document.getElementById(`physical-unit-${row.code}`); if(pu&&row.physUnit) pu.value=row.physUnit;
          const tu=document.getElementById(`transfer-unit-${row.code}`); if(tu&&row.transUnit) tu.value=row.transUnit;
          const au=document.getElementById(`add-transfer-unit-${row.code}`); if(au&&row.addUnit) au.value=row.addUnit;
          const su=document.getElementById(`system-unit-${row.code}`); if(su&&row.sysUnit) su.value=row.sysUnit;
        });
      }

      saveToLocalStorage(){
        const data=this.collectData();
        data.route=this.currentRoute;
        data.expandedCategories=[...this.expandedCategories];
        data.expandedItems=[...this.expandedItems];
        localStorage.setItem(`inventoryData_${this.currentRoute||'default'}`,JSON.stringify(data));
      }
      loadFromLocalStorage(){
        const saved=localStorage.getItem('inventoryData_default');
        if(!saved) return;
        try{
          const data=JSON.parse(saved);
          if(data.expandedCategories) this.expandedCategories=new Set(data.expandedCategories);
          if(data.expandedItems) this.expandedItems=new Set(data.expandedItems);
          this.renderCategories();
        }catch(err){console.error('Failed to load from storage:',err)}
      }

      updateSyncStatus(status){
        const ind=document.getElementById('syncIndicator');
        const txt=document.getElementById('syncText');
        ind.className=`sync-indicator ${status}`;
        txt.textContent = status==='connected'?'Connected':status==='disconnected'?'Offline':'Syncing...';
      }
      showLoading(show){const el=document.getElementById('loading'); if(el) el.className=show?'loading show':'loading'}
      showToast(msg,type='info'){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>t.classList.remove('show'),3000)}
    }

    const app=new InventoryApp();
    window.addEventListener('DOMContentLoaded',()=>app.init());
  </script>

  <script>
    // ---- Apps Script simple-request helper (keeps it as form POST to avoid preflight) ----
    async function callAppsScript(action,payload={}){
      const params=new URLSearchParams();
      params.append('action',action);
      params.append('payload',JSON.stringify(payload));

      const res=await fetch(CONFIG.GOOGLE_SCRIPT_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body:params.toString()
      });

      if(!res.ok){
        const text=await res.text().catch(()=> '');
        throw new Error(`Apps Script error (${res.status}): ${text}`);
      }
      return res.json(); // { status, success, data, timestamp }
    }
  </script>
</body>
</html>
